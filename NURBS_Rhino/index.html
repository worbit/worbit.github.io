<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        canvas.rhino3dm {
            /* margin-left: auto; margin-right: auto; */
            display: block; border: 0px none;
            background-color: skyblue;
        }
    </style>
</head>
<body>
    <script type="text/javascript" src="https://files.mcneel.com/rhino3dm/js/latest/rhino3dm.js"></script>
    <script type="text/javascript" src="https://files.mcneel.com/rhino3dm/js/latest/compute.rhino3d.js"></script>

    <div>
        <canvas class="rhino3dm" id="canvas" width="500" height="500"></canvas>
    </div>

    <script>
        // global variables
var rhino = null;

// wait for the rhino3dm web assembly to load asynchronously
rhino3dm().then(function(m) {
  rhino = m; // global
  run();
});


function getCanvas() { return document.getElementById('canvas'); }
function clientXY(evt) {
  let canvas = getCanvas();
  let rect = canvas.getBoundingClientRect();
  let x = evt.clientX - rect.left;
  let y = evt.clientY - rect.top;
  return [x,y];
}

function run() {
  _points = new rhino.Point3dList();
  let canvas = getCanvas();
  canvas.addEventListener('mousedown', onMouseDown);
  canvas.addEventListener("mousemove", onMouseMove);
}

function onMouseDown(evt) {
  if(evt.buttons==2) {
    // right mouse button down... start over
    _points.delete();
    _points = new rhino.Point3dList();
  } else {
    let [x,y] = clientXY(evt);
    _points.add(x,y,0);
  }
  canvasDraw();
}

function onMouseMove(evt) {
  if(evt.buttons==1) {
    let index = _points.count - 1;
    if(index>=0) {
      let [x,y] = clientXY(evt);
      _points.set(index, [x,y,0]);
      canvasDraw();
    }
  }
}

function canvasDraw() {
  let canvas = getCanvas();
  let ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawNurbsCurve(_points);
  drawControlPolygon(_points);
}

function drawNurbsCurve(controlPoints) {
  if( controlPoints.count<2 )
    return;
  let canvas = getCanvas();
  let ctx = canvas.getContext('2d');
  ctx.lineWidth = 1;
  ctx.strokeStyle = 'black';
  let degree = _points.count-1;
  if(degree>3)
    degree = 3;
  let curve = rhino.NurbsCurve.create(false, degree, _points);
  
  const divisions = 200;
  ctx.beginPath();

  let [t0,t1] = curve.domain;
  let [x,y,z] = curve.pointAt(t0);
  ctx.moveTo(x,y);
  for(j=1; j<=divisions; j++) {
    let t = t0 + j / divisions * (t1-t0);
    let [x,y,z] = curve.pointAt(t);
    ctx.lineTo(x,y);
  }
  ctx.stroke();
  curve.delete();
}

function drawControlPolygon(controlPoints) {
  let canvas = getCanvas();
  let ctx = canvas.getContext('2d');
  ctx.strokestyle = 'darkgray';
  ctx.setLineDash([4,4]);
  ctx.beginPath();
  for(i=0; i<controlPoints.count; i++) {
    let [x,y,z] = controlPoints.get(i);
    if(0==i)
      ctx.moveTo(x, y);
    else
      ctx.lineTo(x, y);
  }
  ctx.stroke();
  
  ctx.setLineDash([]);
  ctx.fillStyle = 'white';
  ctx.strokeStyle = 'black';
  for(i=0; i<controlPoints.count; i++) {
    let [x,y,z] = controlPoints.get(i);
    ctx.fillRect(x-1,y-1, 3, 3);
    ctx.strokeRect(x-2, y-2, 5, 5);
  }
}

    </script>
</body>
</html>